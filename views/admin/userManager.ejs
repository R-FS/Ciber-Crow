<%- include('../partials/head', { title: 'Gestão de Utilizadores' }) %>
<%- include('../partials/header') %>

<main class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Gestão de Utilizadores</h1>
        <a href="/admin" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left"></i> Voltar ao Painel
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="usersTable">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nome de Utilizador</th>
                            <th>Email</th>
                            <th>Admin</th>
                            <th>Data de Registo</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Users will be loaded dynamically via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<%- include('../partials/footer') %>

<!-- Include DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"/>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize DataTable
        const table = $('#usersTable').DataTable({
            ajax: {
                url: '/auth/users',
                dataSrc: ''
            },
            columns: [
                { data: 'id' },
                { data: 'username' },
                { data: 'email' },
                { 
                    data: 'is_admin',
                    render: function(data, type, row) {
                        return data ? '<span class="badge bg-success">Sim</span>' : '<span class="badge bg-secondary">Não</span>';
                    }
                },
                { 
                    data: 'created_at',
                    render: function(data) {
                        return new Date(data).toLocaleString('pt-PT');
                    }
                },
                {
                    data: 'id',
                    orderable: false,
                    render: function(data, type, row) {
                        let actions = `
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-edit" data-id="${data}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${row.id === 1 ? '' : `
                                <button class="btn btn-outline-danger btn-delete" data-id="${data}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                `}
                            </div>
                        `;
                        return actions;
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/pt-PT.json'
            },
            responsive: true
        });

        // Handle edit button click
        $('#usersTable').on('click', '.btn-edit', function() {
            const userId = $(this).data('id');
            // Implement edit functionality
            alert('Editar utilizador: ' + userId);
        });

        // Handle delete button click
        $('#usersTable').on('click', '.btn-delete', function() {
            const userId = $(this).data('id');
            if (confirm('Tem a certeza que deseja eliminar este utilizador?')) {
                // Implement delete functionality
                fetch(`/auth/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        table.ajax.reload();
                        alert('Utilizador eliminado com sucesso!');
                    } else {
                        alert('Erro ao eliminar utilizador: ' + (data.error || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erro ao eliminar utilizador');
                });
            }
        });
    });
</script>

<!-- Include DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
