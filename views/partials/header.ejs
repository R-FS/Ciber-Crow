<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Ciber Crow' %></title>
    <!-- Main Styles -->
    <link rel="stylesheet" href="/css/styles.css">
    <!-- Additional Styles -->
    <% if (typeof styles !== 'undefined' && Array.isArray(styles)) { %>
        <% styles.forEach(function(style) { %>
            <link rel="stylesheet" href="<%= style %>">
        <% }); %>
    <% } %>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<nav class="navbar">
    <div class="navbar-container">
        <div class="logo-container">
            <a href="/" class="logo-link">
                <img src="/images/HLogo3.png" alt="Ciber Crow Logo" class="logo-img" style="z-index: 2;">
            </a>
        </div>
        <div class="nav-links">
            <a href="/">Início</a>
            <a href="/sobre">Sobre</a>
            <a href="/contato">Contato</a>
        </div>
        <div class="nav-links">
            <a href="/speedtest" class="nav-service <%= currentPath === '/speedtest' ? 'active' : '' %>">
                <i class="fas fa-tachometer-alt"></i> Crow Speed
            </a>
            <div class="security-dropdown">
                <% const isSecuritySection = currentPath === '/security' || currentPath === '/network-monitoring' %>
                <a href="#" class="nav-service security-dropdown-toggle <%= isSecuritySection ? 'active' : '' %>">
                    <i class="fas fa-shield-alt"></i> Crow Security <i class="fas fa-caret-down"></i>
                </a>
                <div class="security-dropdown-menu">
                    <a href="/security" class="<%= currentPath === '/security' ? 'active' : '' %>">
                        <i class="fas fa-shield-alt"></i> Security Dashboard
                    </a>
                    <a href="/network-monitoring" class="<%= currentPath === '/network-monitoring' ? 'active' : '' %>">
                        <i class="fas fa-network-wired"></i> Network Monitoring
                    </a>
                </div>
            </div>
        </div>
        <div class="nav-links" id="auth-buttons" data-authenticated="<%= typeof isAuthenticated !== 'undefined' && isAuthenticated ? 'true' : 'false' %>">
            <a href="/login" id="login-button">
                <i class="fas fa-sign-in-alt"></i><span class="auth-text">Login</span>
            </a>
            <div id="user-menu">
                <button id="userDropdown" class="user-dropdown-button">
                    <i class="fas fa-user-circle user-dropdown-icon"></i>
                    <span id="username-display" class="user-dropdown-text">Conta</span>
                    <i class="fas fa-caret-down user-dropdown-caret"></i>
                </button>
                <div id="dropdownContent" class="user-dropdown">
                    <div class="user-dropdown-header">
                        <div id="dropdown-username" class="user-dropdown-username">Usuário</div>
                        <small id="dropdown-email" class="user-dropdown-email">user@example.com</small>
                    </div>
                    <% if (user && user.isAdmin) { %>
                    <a href="/admin" class="user-dropdown-link">
                        <i class="fas fa-cog"></i> Painel Admin
                    </a>
                    <% } %>
                    <a href="/perfil" class="user-dropdown-link">
                        <i class="fas fa-user"></i>Meu Perfil
                    </a>
                    <a href="/configuracoes" class="user-dropdown-link">
                        <i class="fas fa-cog"></i>Configurações
                    </a>
                    <a href="#" id="logout-button" class="user-dropdown-link logout">
                        <i class="fas fa-sign-out-alt"></i><span class="auth-text">Sair</span>
                    </a>
                </div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const authButtons = document.getElementById('auth-buttons');
                const loginButton = document.getElementById('login-button');
                const userMenu = document.getElementById('user-menu');
                const dropdownButton = document.getElementById('userDropdown');
                const dropdownContent = document.getElementById('dropdownContent');
                const logoutButton = document.getElementById('logout-button');
                const usernameDisplay = document.getElementById('username-display');
                
                // Check if user is authenticated and show/hide elements accordingly
                const isAuthenticated = authButtons.getAttribute('data-authenticated') === 'true';
                if (isAuthenticated) {
                    if (loginButton) loginButton.style.display = 'none';
                    if (userMenu) userMenu.style.display = 'inline-block';
                } else {
                    if (loginButton) loginButton.style.display = 'inline-block';
                    if (userMenu) userMenu.style.display = 'none';
                }
                
                // Toggle do dropdown
                if (dropdownButton && dropdownContent) {
                    dropdownButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
                    });
                }

                // Fechar dropdown ao clicar fora
                document.addEventListener('click', function() {
                    if (dropdownContent && dropdownContent.style.display === 'block') {
                        dropdownContent.style.display = 'none';
                    }
                });

                // Verificar se o usuário está autenticado
                const user = localStorage.getItem('user');
                if (user) {
                    const userData = JSON.parse(user);
                    
                    // Atualizar informações do usuário
                    if (usernameDisplay) {
                        usernameDisplay.textContent = userData.username || 'Conta';
                    }
                    
                    const dropdownUsername = document.getElementById('dropdown-username');
                    const dropdownEmail = document.getElementById('dropdown-email');
                    
                    if (dropdownUsername) dropdownUsername.textContent = userData.username || 'Usuário';
                    if (dropdownEmail) dropdownEmail.textContent = userData.email || '';
                }
                
                // Logout
                if (logoutButton) {
                    logoutButton.addEventListener('click', async function(e) {
                        e.preventDefault();
                        try {
                            const response = await fetch('/api/auth/logout', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                                },
                                credentials: 'include'
                            });
                            
                            if (response.ok) {
                                // Limpar todos os dados locais
                                localStorage.clear();
                                sessionStorage.clear();
                                
                                // Limpar cookies forçando expiração
                                document.cookie = 'token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                                document.cookie = 'refreshToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                                
                                // Forçar um hard refresh para garantir que todos os estados sejam limpos
                                window.location.href = '/?logout=true';
                            } else {
                                throw new Error('Falha ao fazer logout');
                            }
                        } catch (error) {
                            console.error('Erro ao fazer logout:', error);
                            // Mesmo em caso de erro, tenta limpar os dados locais e redirecionar
                            localStorage.clear();
                            sessionStorage.clear();
                            window.location.href = '/';
                        }
                    });
                }

                // Security Dropdown Toggle
                const securityDropdown = document.querySelector('.security-dropdown');
                const securityToggle = document.querySelector('.security-dropdown-toggle');
                const securityMenu = document.querySelector('.security-dropdown-menu');

                if (securityToggle && securityMenu) {
                    // Toggle menu on click
                    securityToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        const isOpen = securityMenu.style.display === 'block';
                        securityMenu.style.display = isOpen ? 'none' : 'block';
                        securityMenu.style.opacity = isOpen ? '0' : '1';
                        securityMenu.style.transform = isOpen ? 'translateY(-10px)' : 'translateY(0)';
                    });

                    // Close menu when clicking outside
                    document.addEventListener('click', function(e) {
                        if (!securityDropdown.contains(e.target)) {
                            securityMenu.style.display = 'none';
                            securityMenu.style.opacity = '0';
                            securityMenu.style.transform = 'translateY(-10px)';
                        }
                    });

                    // Close menu when clicking on a menu item
                    const menuItems = securityMenu.querySelectorAll('a');
                    menuItems.forEach(item => {
                        item.addEventListener('click', function() {
                            securityMenu.style.display = 'none';
                            securityMenu.style.opacity = '0';
                            securityMenu.style.transform = 'translateY(-10px)';
                        });
                    });
                }
            });
        </script>
    </div>
</nav>
        <div class="header-space" style="height: 40px;"></div>
</body>
</html>
