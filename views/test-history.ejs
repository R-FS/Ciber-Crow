<!DOCTYPE html>
<html lang="pt">
<head>
   <link rel="stylesheet" href="/css/styles.css">
   <title><%= title %></title>
   <meta name="description" content="<%= description %>">
</head>
<body>
    <%- include('partials/header') %>
    
    <div class="container">
        <div class="speed-test">
            <h1 class="title"><i class="fas fa-history"></i> Histórico de Testes</h1>
            <p class="subtitle">Visualize o histórico dos seus testes de velocidade</p>
            
            <div id="authRequired" class="save-info" style="display: none;">
                <i class="fas fa-info-circle"></i>
                <div class="alert-content">
                    <p>Você precisa estar autenticado para acessar seu histórico de testes.</p>
                    <div class="button-group" style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <a href="/login?redirect=<%= encodeURIComponent('/test-history') %>" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Fazer Login
                        </a>
                        <a href="/register" class="btn btn-outline">
                            <i class="fas fa-user-plus"></i> Criar Conta
                        </a>
                    </div>
                </div>
            </div>

            <div id="authenticatedContent" style="display: none;">
                <div class="form-group" style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <button id="loadHistory" class="btn btn-primary">
                        <i class="fas fa-sync"></i> Atualizar
                    </button>
                    <select id="limitSelect" class="form-control" style="max-width: 200px;">
                        <option value="5">Últimos 5 testes</option>
                        <option value="10" selected>Últimos 10 testes</option>
                        <option value="20">Últimos 20 testes</option>
                        <option value="50">Últimos 50 testes</option>
                        <option value="0">Todos os testes</option>
                    </select>
                </div>

                <div id="loading" class="loading" style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);">
                    <i class="fas fa-spinner fa-spin"></i> Carregando histórico...
                </div>

                <div class="card" style="background-color: rgba(10, 25, 47, 0.5); border-radius: 10px; padding: 1.5rem; margin-top: 1.5rem;">
                    <div class="table-responsive">
                        <table class="table" style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead>
                                <tr>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: var(--primary-color);">
                                        <i class="far fa-calendar"></i> Data
                                    </th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: var(--primary-color);">
                                        <i class="fas fa-download"></i> Download
                                    </th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: var(--primary-color);">
                                        <i class="fas fa-upload"></i> Upload
                                    </th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: var(--primary-color);">
                                        <i class="fas fa-tachometer-alt"></i> Ping
                                    </th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: var(--primary-color);">
                                        <i class="fas fa-wave-square"></i> Jitter
                                    </th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: var(--primary-color);">
                                        <i class="fas fa-server"></i> Servidor
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="historyBody" style="color: var(--text-light);">
                                <!-- Dados serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Função para formatar a data
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Data inválida';
            
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            return date.toLocaleDateString('pt-BR', options);
        }
        
        // Função para formatar a velocidade
        function formatSpeed(speed) {
            if (speed === null || speed === undefined) return 'N/A';
            const speedNum = parseFloat(speed);
            return !isNaN(speedNum) ? speedNum.toFixed(2) + ' Mbps' : 'N/A';
        }
        
        // Função para formatar o ping/jitter
        function formatPing(ping) {
            if (ping === null || ping === undefined) return 'N/A';
            const pingNum = parseFloat(ping);
            return !isNaN(pingNum) ? Math.round(pingNum) + ' ms' : 'N/A';
        }
        
        // Função para carregar o histórico
        async function loadHistory() {
            const limit = document.getElementById('limitSelect')?.value || '10';
            const loadingDiv = document.getElementById('loading');
            const historyBody = document.getElementById('historyBody');
            
            if (!loadingDiv || !historyBody) {
                console.error('Elementos necessários não encontrados no DOM');
                return;
            }
            
            try {
                loadingDiv.style.display = 'block';
                historyBody.innerHTML = '';
                
                const response = await fetch(`/api/speedtest/history?limit=${limit}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar o histórico: ' + response.status);
                }
                
                const tests = await response.json();
                
                if (!Array.isArray(tests) || tests.length === 0) {
                    historyBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem;">
                                <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.5; margin-bottom: 1rem;"></i>
                                <p>Nenhum teste encontrado</p>
                            </td>
                        </tr>`;
                    return;
                }
                
                tests.forEach(test => {
                    if (!test) return;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(test.testDate)}</td>
                        <td>${formatSpeed(test.downloadSpeed)}</td>
                        <td>${formatSpeed(test.uploadSpeed)}</td>
                        <td>${formatPing(test.ping)}</td>
                        <td>${formatPing(test.jitter)}</td>
                        <td>${test.serverName || 'N/A'}</td>
                    `;
                    historyBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                if (historyBody) {
                    historyBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--error-color); padding: 2rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>Erro ao carregar o histórico. Tente novamente.</p>
                                <button onclick="loadHistory()" class="btn" style="margin-top: 1rem;">
                                    <i class="fas fa-sync"></i> Tentar novamente
                                </button>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                                    ${error.message || 'Erro desconhecido'}
                                </p>
                            </td>
                        </tr>`;
                }
            } finally {
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }
        }
        
        // Função para verificar a autenticação com o servidor
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Falha na verificação de autenticação');
                }
                
                const data = await response.json();
                return !!data.authenticated;
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                return false;
            }
        }

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async () => {
            const authRequired = document.getElementById('authRequired');
            const authenticatedContent = document.getElementById('authenticatedContent');
            const loadHistoryBtn = document.getElementById('loadHistory');
            const limitSelect = document.getElementById('limitSelect');
            
            if (!authRequired || !authenticatedContent || !loadHistoryBtn || !limitSelect) {
                console.error('Elementos necessários não encontrados no DOM');
                return;
            }
            
            // Mostra o estado de carregamento
            authRequired.style.display = 'none';
            authenticatedContent.style.display = 'none';
            
            try {
                // Verifica autenticação
                const isAuthenticated = await checkAuth();
                
                if (!isAuthenticated) {
                    authRequired.style.display = 'flex';
                    return;
                }
                
                // Se autenticado, mostra o conteúdo e carrega o histórico
                authenticatedContent.style.display = 'block';
                
                // Event listeners
                loadHistoryBtn.addEventListener('click', loadHistory);
                limitSelect.addEventListener('change', loadHistory);
                
                // Carrega o histórico inicial
                await loadHistory();
            } catch (error) {
                console.error('Erro na inicialização:', error);
                if (authRequired) {
                    authRequired.style.display = 'flex';
                    const alertContent = authRequired.querySelector('.alert-content');
                    if (alertContent) {
                        alertContent.innerHTML = `
                            <p>Ocorreu um erro ao carregar a página. Por favor, tente recarregar.</p>
                            <div style="margin-top: 1rem;">
                                <button onclick="window.location.reload()" class="btn">
                                    <i class="fas fa-sync"></i> Recarregar Página
                                </button>
                            </div>
                        `;
                    }
                }
            }
        });
    </script>
</body>
</html>
