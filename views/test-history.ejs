<!DOCTYPE html>
<html lang="pt">
<%- include('partials/head') %>
<body>
    <%- include('partials/header') %>
    
    <div class="history-container">
    <div class="history-header">
        <h1><i class="fas fa-history"></i> Histórico de Testes</h1>
        <p>Visualize o histórico dos seus testes de velocidade</p>
    </div>
    
    <div id="authRequired" class="save-info" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <div class="alert-content">
            <p>Você precisa estar autenticado para acessar seu histórico de testes.</p>
            <div class="button-group" style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                <a href="/login?redirect=<%= encodeURIComponent('/test-history') %>" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Fazer Login
                </a>
                <a href="/register" class="btn btn-outline">
                    <i class="fas fa-user-plus"></i> Criar Conta
                </a>
            </div>
        </div>
    </div>

    <div id="authenticatedContent" style="display: none;">
        <div class="history-controls">
            <button id="loadHistory" class="btn btn-primary">
                <i class="fas fa-sync"></i> Atualizar
            </button>
            <select id="limitSelect" class="form-control" style="max-width: 200px;">
                <option value="5">Últimos 5 testes</option>
                <option value="10" selected>Últimos 10 testes</option>
                <option value="20">Últimos 20 testes</option>
                <option value="50">Últimos 50 testes</option>
                <option value="0">Todos os testes</option>
            </select>
        </div>

        <div id="loading" class="history-loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Carregando histórico...</p>
        </div>

        <div class="history-card">
            <table class="history-table">
                <thead>
                    <tr>
                        <th><i class="far fa-calendar"></i> Data</th>
                        <th><i class="fas fa-download"></i> Download</th>
                        <th><i class="fas fa-upload"></i> Upload</th>
                        <th><i class="fas fa-tachometer-alt"></i> Ping</th>
                        <th><i class="fas fa-wave-square"></i> Jitter</th>
                        <th><i class="fas fa-server"></i> Servidor</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- Dados serão carregados aqui -->
                </tbody>
            </table>
        </div>
            </div>
        </div>
    </div>

    <script>
        // Função para formatar a data
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Data inválida';
            
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            return date.toLocaleDateString('pt-BR', options);
        }
        
        // Função para formatar a velocidade
        function formatSpeed(speed) {
            if (speed === null || speed === undefined) return 'N/A';
            const speedNum = parseFloat(speed);
            return !isNaN(speedNum) ? speedNum.toFixed(2) + ' Mbps' : 'N/A';
        }
        
        // Função para formatar o ping/jitter
        function formatPing(ping) {
            if (ping === null || ping === undefined) return 'N/A';
            const pingNum = parseFloat(ping);
            return !isNaN(pingNum) ? Math.round(pingNum) + ' ms' : 'N/A';
        }
        
        // Função para carregar o histórico
        async function loadHistory() {
            const limit = document.getElementById('limitSelect')?.value || '10';
            const loadingDiv = document.getElementById('loading');
            const historyBody = document.getElementById('historyBody');
            
            if (!loadingDiv || !historyBody) {
                console.error('Elementos necessários não encontrados no DOM');
                return;
            }
            
            try {
                loadingDiv.style.display = 'block';
                historyBody.innerHTML = '';
                
                const response = await fetch(`/api/speedtest/history?limit=${limit}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar o histórico: ' + response.status);
                }
                
                const tests = await response.json();
                
                if (!Array.isArray(tests) || tests.length === 0) {
                    historyBody.innerHTML = `
                        <tr>
                            <td colspan="6">
                                <div class="history-empty">
                                    <i class="fas fa-inbox"></i>
                                    <p>Nenhum teste encontrado</p>
                                    <p class="subtext">Realize um teste de velocidade para começar</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }
                
                tests.forEach(test => {
                    if (!test) return;
                    
                    const row = document.createElement('tr');
                    
                    // Format speed values with separate number and unit for better styling
                    const downloadValue = test.downloadSpeed ? parseFloat(test.downloadSpeed).toFixed(2) : 'N/A';
                    const uploadValue = test.uploadSpeed ? parseFloat(test.uploadSpeed).toFixed(2) : 'N/A';
                    const pingValue = test.ping ? Math.round(test.ping) : 'N/A';
                    const jitterValue = test.jitter ? Math.round(test.jitter) : 'N/A';
                    
                    row.innerHTML = `
                        <td data-label="Data">${formatDate(test.testDate)}</td>
                        <td data-label="Download">
                            <span class="speed-value">${downloadValue}</span>
                            ${downloadValue !== 'N/A' ? '<span class="speed-unit">Mbps</span>' : ''}
                        </td>
                        <td data-label="Upload">
                            <span class="speed-value">${uploadValue}</span>
                            ${uploadValue !== 'N/A' ? '<span class="speed-unit">Mbps</span>' : ''}
                        </td>
                        <td data-label="Ping">
                            <span class="speed-value">${pingValue}</span>
                            ${pingValue !== 'N/A' ? '<span class="speed-unit">ms</span>' : ''}
                        </td>
                        <td data-label="Jitter">
                            <span class="speed-value">${jitterValue}</span>
                            ${jitterValue !== 'N/A' ? '<span class="speed-unit">ms</span>' : ''}
                        </td>
                        <td data-label="Servidor">${test.serverName || 'N/A'}</td>
                    `;
                    historyBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                if (historyBody) {
                    historyBody.innerHTML = `
                        <tr>
                            <td colspan="6">
                                <div class="history-error">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>Erro ao carregar o histórico</p>
                                    <p class="error-details">${error.message || 'Erro desconhecido'}</p>
                                    <button onclick="loadHistory()" class="btn btn-primary" style="margin-top: 1rem;">
                                        <i class="fas fa-sync"></i> Tentar novamente
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                }
            } finally {
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }
        }
        
        // Função para verificar a autenticação com o servidor
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Falha na verificação de autenticação');
                }
                
                const data = await response.json();
                return !!data.authenticated;
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                return false;
            }
        }

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async () => {
            const authRequired = document.getElementById('authRequired');
            const authenticatedContent = document.getElementById('authenticatedContent');
            const loadHistoryBtn = document.getElementById('loadHistory');
            const limitSelect = document.getElementById('limitSelect');
            
            if (!authRequired || !authenticatedContent || !loadHistoryBtn || !limitSelect) {
                console.error('Elementos necessários não encontrados no DOM');
                return;
            }
            
            // Mostra o estado de carregamento
            authRequired.style.display = 'none';
            authenticatedContent.style.display = 'none';
            
            try {
                // Verifica autenticação
                const isAuthenticated = await checkAuth();
                
                if (!isAuthenticated) {
                    authRequired.style.display = 'flex';
                    return;
                }
                
                // Se autenticado, mostra o conteúdo e carrega o histórico
                authenticatedContent.style.display = 'block';
                
                // Event listeners
                loadHistoryBtn.addEventListener('click', loadHistory);
                limitSelect.addEventListener('change', loadHistory);
                
                // Carrega o histórico inicial
                await loadHistory();
            } catch (error) {
                console.error('Erro na inicialização:', error);
                if (authRequired) {
                    authRequired.style.display = 'flex';
                    const alertContent = authRequired.querySelector('.alert-content');
                    if (alertContent) {
                        alertContent.innerHTML = `
                            <p>Ocorreu um erro ao carregar a página. Por favor, tente recarregar.</p>
                            <div style="margin-top: 1rem;">
                                <button onclick="window.location.reload()" class="btn">
                                    <i class="fas fa-sync"></i> Recarregar Página
                                </button>
                            </div>
                        `;
                    }
                }
            }
        });
    </script>
</body>
</html>
